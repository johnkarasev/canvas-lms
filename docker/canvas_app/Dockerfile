FROM ubuntu

RUN apt-get upgrade -y
RUN apt-get update -y
RUN apt-get install git-core -y
RUN git clone https://github.com/instructure/canvas-lms.git canvas
RUN cd canvas
RUN git checkout stable
RUN mkdir -p /var/canvas
RUN chown -R sysadmin /var/canvas
RUN cd canvas
RUN cp -av . /var/canvas
RUN cd /var/canvas
RUN add-apt-repository ppa:brightbox/ruby-ng
RUN apt-get update -y
RUN apt-get install ruby2.4 ruby2.4-dev zlib1g-dev libxml2-dev \
                           libsqlite3-dev postgresql libpq-dev \
                           libxmlsec1-dev curl make g++ -y
RUN curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
RUN apt-get install nodejs -y
RUN gem install bundler --version 1.13.6
RUN bundle install --path vendor/bundle
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
RUN sudo apt-get update -y && sudo apt-get install yarn=1.6.0-1
RUN apt-get install python -y
RUN yarn install
RUN cp config/dynamic_settings.yml.example config/dynamic_settings.yml
#RUN cp config/database.yml.example config/database.yml
#RUN cp config/outgoing_mail.yml.example config/outgoing_mail.yml
#RUN cp config/domain.yml.example config/domain.yml
#RUN cp config/security.yml.example config/security.yml
COPY database.yml ./config
COPY outgoing_mail.yml ./config
COPY security.yml ./config
COPY domain.yml ./config
RUN mkdir -p log tmp/pids public/assets app/stylesheets/brandable_css_brands
RUN touch app/stylesheets/_brandable_variables_defaults_autogenerated.scss
RUN touch Gemfile.lock
RUN touch log/production.log
RUN sudo chown -R canvasuser config/environment.rb log tmp public/assets \
                                  app/stylesheets/_brandable_variables_defaults_autogenerated.scss \
                                  app/stylesheets/brandable_css_brands Gemfile.lock config.ru
RUN yarn install
RUN RAILS_ENV=production bundle exec rake canvas:compile_assets
RUN chown -R canvasuser public/dist/brandable_css

